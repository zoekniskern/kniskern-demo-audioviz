<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Kniskern Web Audio Visualizer</title>
    <style>
        body {
            background: #efefef;
            font-family: tahoma, verdana, sans serif;
        }
        
        canvas {
            margin-left:10px;
            margin-top:10px;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
            background: black;
        }
        
        #controls {
            margin-left:10px;
            margin-top:10px;
        }
    </style>
    <script>
        //IIFE
        (function(){
            "use strict";
            
            //GLOBALS
            var NUM_SAMPLES = 256;
            var SOUND_1 = 'media/Issues.mp3';
            var SOUND_2 = 'media/African Queen.mp3';
            var audioElement;
            var analyserNode;
            var canvas;
            var ctx;
            
            //Init function will call itself because of IIFE
            function init(){
                //get canvas
                canvas = document.querySelector('canvas');
                ctx = canvas.getContext("2d");
                
                //reference <audio> element on page
                audioElement = document.querySelector('audio');
                
                //call helper function to get analyzer node
                analyserNode = createWebAudioContextWithAnalyserNode(audioElement);
                
                //get sound track <select> and Full Screen button working
                setupUI();
                
                //load and play default sounds into audio element
                playStream(audioElement, SOUND_1);
                
                //start animation loop
                update();
            }
            
            //createWebAudtioContextWithAnalyzerNode function
            function createWebAudioContextWithAnalyserNode(audioElement){
                var audioCtx;
                var analyserNode;
                var sourceNode;
                //create new AudioContext;
                //use || for WebAudio crossbrower compatibility
                audioCtx = new (window.AudioContext || window.webkitAudioContext);
                
                //create analyzer node
                analyserNode = audioCtx.createAnalyser();
                
                /*
                request NUM_SAMPLES - number of samples across the sound spectrum
                each sample contains # between 0-255 representing the amplitude of that frequency
                */
                //fft = Fast Fourier Transform
                analyserNode.fftSize = NUM_SAMPLES;
                
                //hook up the <audio> element to the analyserNode
                sourceNode = audioCtx.createMediaElementSource(audioElement);
            
                sourceNode.connect(analyserNode);
                
                //connect to destination
                analyserNode.connect(audioCtx.destination);
                return analyserNode;
            }
            
            //setupUI function
            function setupUI(){
                document.querySelector("#trackSelect").onchange = function(e){
                    playStream(audioElement,e.target.value);
                };
                document.querySelector("#fsButton").onclick = function(){
                    requestFullScreen(canvas);
                }
            }
            
            //playStream function
            function playStream(audioElement,path){
                audioElement.src = path;
                audioElement.play();
                audioElement.volume = 0.2;
                document.querySelector("#status").innerHTML = "Now playing: " + path;
            }
            
            //update function
            function update(){
                //calls update() method 1/60sec
                requestAnimationFrame(update);
                
                //Nyquist Theorem
                //array of 8-bit integers (0-255)
                var data = new Uint8Array(NUM_SAMPLES/2);
                
                //use frequency data inside array
                analyserNode.getByteFrequencyData(data);
                /////////////or waveform data
                /////analyzerNode.getByteTimeDomainData(data);
                
                //draw
                ctx.clearRect(0,0,800,600);
                //drawing variables
                var barWidth = 4;
                var barSpacing = 1;
                var barHeight = 100;
                var topSpacing = 50;
                
                //loop through the data and draw
                for(var i=0; i<data.length; i++){
                    ctx.fillStyle = 'rgba(0,255,0,0.6)';
                    
                    //higher amplitude = taller bar
                    ctx.fillRect(i*(barWidth + barSpacing), topSpacing + 256 - data[i], barWidth, barHeight);
                } 
            }
            
            //Helper function
            function makeColor(red, green, blue, alpha){
                var color='rgba('+red+','+green+','+blue+ ','+alpha+')';
                return color;
            }
            
            //Full Screen function
            //crossbrowser compatibility
            function requestFullscreen(element){
                if(element.requestFullscreen){
                    element.requestFullscreen();
                } else if(element.mozRequestFullscreen){
                    element.mozRequestFullscreen();
                } else if(element.mozRequestFullScreen){
                    element.mozRequestFullScreen();
                } else if(element.webkitRequestFullscreen){
                    element.webkitRequestFullscreen();
                }
                //nothing happens if it WebAudio isn't supported
            }
            
            window.addEventListener("load",init);
        }());
    </script>
    <body>
        <canvas id="canvas" width="640" height="400"></canvas>
        <div id="controls">
            <audio controls loop></audio>
            <label>Track:
                <select id="trackSelect">
                    <option value="media/Issues.mp3">Issues (Zouk Remix)</option>
                    <option value="media/African Queen.mp3">African Queen</option>
                </select>
            </label>
            <button id="fsButton">Go Full Screen</button><br>
            <p id="status">???</p>
        </div>
    </body>
</head>
</html>